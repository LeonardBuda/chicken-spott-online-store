{% extends "base.html" %}
{% block title %}Checkout - 010 Café{% endblock %}
{% block content %}
    <h1>Checkout 🛒💳</h1>
    <div class="order-summary">
        <h2>Order Summary 🌟</h2>
        <ul>
            {% for item in cart_items %}
                <li>
                    {{ item.name }} - {% if 'quantity' in item %}R{{ item.amount|floatformat(2) }} x {{ item.quantity }} = R{{ item.total|floatformat(2) }}{% else %}R{{ item.amount|floatformat(2) }}{% endif %}
                </li>
            {% endfor %}
        </ul>
        <p>Total: R{{ total|floatformat(2) }} 💸</p>
        {% if delivery_fee is defined %}
            <p>Delivery Fee: R{{ delivery_fee|floatformat(2) }} ({{ distance_km|floatformat(2) }} km @ R6/km)</p>
        {% endif %}
    </div>
    <div class="contact-form">
        <h2>Customer Details 📝</h2>
        <form method="POST" action="{{ url_for('checkout') }}" id="checkoutForm">
            <input type="text" name="name" placeholder="Name" value="{{ remembered_customer.get('name', '') }}" required>
            <input type="text" name="surname" placeholder="Surname" value="{{ remembered_customer.get('surname', '') }}">
            <input type="text" name="phone" placeholder="Phone" value="{{ remembered_customer.get('phone', '') }}" required>
            <input type="email" name="email" placeholder="Email" value="{{ remembered_customer.get('email', '') }}" required>
            <label>Order Type:</label>
            <input type="radio" name="delivery" value="false" checked> Collection 📦
            <input type="radio" name="delivery" value="true" id="deliveryRadio"> Delivery 🚚
            <input type="text" name="address" placeholder="Delivery Address" id="deliveryAddress" style="display: none;">
            <select name="payment_method" required>
                <option value="" disabled selected>Select payment method</option>
                <option value="Cash on delivery">Cash on delivery</option>
                <option value="Cash on collection">Cash on collection</option>
                <option value="Card on delivery">Card on delivery</option>
                <option value="Card on collection">Card on collection</option>
                <option value="In-App" disabled>In-App (coming soon)</option>
            </select>
            <label><input type="checkbox" name="remember"> Remember me</label>
            <button type="submit">Place Order 🚀</button>
        </form>
    </div>
    <p><a href="{{ url_for('view_cart') }}">Back ⬅️</a></p>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const deliveryRadio = document.getElementById('deliveryRadio');
            const deliveryAddress = document.getElementById('deliveryAddress');
            deliveryRadio.addEventListener('change', function() {
                deliveryAddress.style.display = this.checked ? 'block' : 'none';
            });
            document.getElementById('checkoutForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                fetch('/checkout', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                    } else if (data.stay) {
                        alert(data.message);
                        window.location.href = '{{ url_for('home') }}'; // Redirect to home after pop-up
                    }
                })
                .catch(error => alert('Error submitting checkout: ' + error));
            });
        });
    </script>
{% endblock %}